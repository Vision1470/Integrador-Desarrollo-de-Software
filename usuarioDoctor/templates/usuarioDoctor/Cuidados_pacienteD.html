<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cuidados del paciente</title>
</head>
<body>
    <h1>Cuidados del Paciente: {{ paciente.nombres }} {{ paciente.apellidos }}</h1>

    {% if messages %}
    <div>
        {% for message in messages %}
            <div>{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    {% if receta %}
        <table border="1">
            <tr>
                <th>Padecimientos</th>
                <th>Cuidados</th>
                <th>Medicamentos</th>
            </tr>
            <tr>
                <td>
                    {% for padecimiento in padecimientos %}
                        <div>
                            {{ padecimiento.padecimiento.nombre }}
                            ({{ padecimiento.get_nivel_gravedad_display }})
                        </div>
                    {% endfor %}
                </td>
                <td>
                    {% for cuidado in cuidados %}
                        <div>
                            <input type="checkbox" 
                                   disabled
                                   {% if ultimo_registro %}
                                       {% for registro in ultimo_registro.registrocuidado_set.all %}
                                           {% if registro.cuidado_id == cuidado.id and registro.completado %}
                                               checked
                                           {% endif %}
                                       {% endfor %}
                                   {% endif %}>
                            <label>{{ cuidado.cuidado.nombre }}</label>
                            {% if ultimo_registro %}
                                {% for registro in ultimo_registro.registrocuidado_set.all %}
                                    {% if registro.cuidado_id == cuidado.id and registro.completado %}
                                        <div>
                                            Completado por: {{ ultimo_registro.registrado_por.get_full_name }}
                                            el {{ ultimo_registro.fecha_registro|date:"d/m/Y H:i" }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endfor %}
                </td>
                <td>
                    {% for medicamento in medicamentos %}
                        <div>
                            <input type="checkbox" 
                                   disabled
                                   {% if ultimo_registro %}
                                       {% for registro in ultimo_registro.registromedicamento_set.all %}
                                           {% if registro.medicamento_id == medicamento.id and registro.administrado %}
                                               checked
                                           {% endif %}
                                       {% endfor %}
                                   {% endif %}>
                            <label>
                                {{ medicamento.medicamento.nombre }} - {{ medicamento.cantidad_por_toma }}
                                {{ medicamento.get_unidad_medida_display }}
                            </label>
                            {% if ultimo_registro %}
                                {% for registro in ultimo_registro.registromedicamento_set.all %}
                                    {% if registro.medicamento_id == medicamento.id and registro.administrado %}
                                        <div>
                                            Administrado por: {{ ultimo_registro.registrado_por.get_full_name }}
                                            el {{ ultimo_registro.fecha_registro|date:"d/m/Y H:i" }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endfor %}
                </td>
            </tr>
        </table>
    {% else %}
    <p>No hay una receta activa para este paciente.</p>
    {% endif %}

    {% if registros_recientes %}
    <div>
        <h3>Ãšltimos Registros</h3>
        <table border="1">
            <tr>
                <th>Fecha</th>
                <th>Registrado por</th>
                <th>Cuidados Completados</th>
                <th>Medicamentos Administrados</th>
            </tr>
            {% for registro in registros_recientes %}
            <tr>
                <td>{{ registro.fecha_registro|date:"d/m/Y H:i" }}</td>
                <td>{{ registro.registrado_por.get_full_name }}</td>
                <td>
                    {% for cuidado in registro.registrocuidado_set.all %}
                        {% if cuidado.completado %}
                            - {{ cuidado.cuidado.cuidado.nombre }}<br>
                        {% endif %}
                    {% endfor %}
                </td>
                <td>
                    {% for medicamento in registro.registromedicamento_set.all %}
                        {% if medicamento.administrado %}
                            - {{ medicamento.medicamento.medicamento.nombre }}<br>
                        {% endif %}
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <br><br>
    <a href="{% url 'doctor:pacientes_doctor' %}">
        <button type="button">Volver</button>
    </a>
</body>
</html>