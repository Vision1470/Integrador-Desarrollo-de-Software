<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial de Pacientes</title>
</head>
<body>
    <h1>Historial de Pacientes</h1>

    <!-- Filtros -->
    <form method="GET" action="">
        <input type="text" name="busqueda" placeholder="Buscar por nombre o NSS" value="{{ request.GET.busqueda }}">
        <input type="date" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}">
        <input type="date" name="fecha_fin" value="{{ request.GET.fecha_fin }}">
        <button type="submit">Buscar</button>
    </form>

    <!-- Tabla de Historiales -->
    <table border="1">
        <thead>
            <tr>
                <th>Nombre Completo</th>
                <th>NSS</th>
                <th>Fecha de Ingreso</th>
                <th>Número de Ingresos</th>
                <th>Última Receta</th>
                <th>Último Diagnóstico</th>
                <th>Último Seguimiento</th>
                <th>Ver Detalles</th>
            </tr>
        </thead>
        <tbody>
            {% for paciente in pacientes %}
                <tr>
                    <td>{{ paciente.nombres }} {{ paciente.apellidos }}</td>
                    <td>{{ paciente.num_seguridad_social }}</td>
                    <td>{{ paciente.fecha_ingreso|date:"d/m/Y H:i" }}</td>
                    <td>{{ paciente.numero_ingresos }}</td>
                    <td>
                        {% with ultima_receta=paciente.recetas_doctor.first %}
                            {% if ultima_receta %}
                                {{ ultima_receta.fecha_creacion|date:"d/m/Y" }}
                            {% else %}
                                Sin recetas
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td>
                        {% with ultimo_diagnostico=paciente.diagnosticos.first %}
                            {% if ultimo_diagnostico %}
                                {{ ultimo_diagnostico.fecha_creacion|date:"d/m/Y" }}
                            {% else %}
                                Sin diagnósticos
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td>
                        {% with ultimo_seguimiento=paciente.seguimientocuidados_set.first %}
                            {% if ultimo_seguimiento %}
                                {{ ultimo_seguimiento.fecha_registro|date:"d/m/Y" }}
                            {% else %}
                                Sin seguimientos
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td>
                        <a href="{% url 'jefa:detalle_historial' paciente.id %}" class="btn">
                            Ver Historial Completo
                        </a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>