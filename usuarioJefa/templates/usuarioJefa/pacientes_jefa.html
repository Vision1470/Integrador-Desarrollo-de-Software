<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pacientes</title>
    <script>
        function confirmarAlta(pacienteId) {
    if (confirm('¿Está seguro que desea dar de alta a este paciente?')) {
        console.log('Intentando dar de alta al paciente:', pacienteId); // Debug
        fetch(`{% url 'jefa:dar_alta_paciente' 0 %}`.replace('0', pacienteId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            console.log('Respuesta recibida:', response); // Debug
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data); // Debug
            if (data.status === 'success') {
                alert('Paciente dado de alta exitosamente');
                location.reload();
            } else {
                alert('Error al dar de alta al paciente: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error en la petición:', error); // Debug
            alert('Error en la petición: ' + error);
        });
    }
}

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</head>
<body>
    <h1>Pacientes</h1>
    
    <table border="1">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Apellidos</th>
                <th>Número SS</th>
                <th>Fecha Nacimiento</th>
                <th>Sexo</th>
                <th>Área</th>
                <th>Doctor</th>
                <th>Enfermero/a</th>
                <th>Hospital Origen</th>
                <th>Número de Ingresos</th>
                <th>Fecha de Ingreso</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% if pacientes %}
                {% for paciente in pacientes %}
                    <tr>
                        <td>{{ paciente.nombres }}</td>
                        <td>{{ paciente.apellidos }}</td>
                        <td>{{ paciente.num_seguridad_social }}</td>
                        <td>{{ paciente.fecha_nacimiento|date:"d/m/Y" }}</td>
                        <td>{{ paciente.sexo }}</td>
                        <td>{{ paciente.area }}</td>
                        <td>{{ paciente.doctor_actual }}</td>
                        <td>{{ paciente.enfermero_actual }}</td>
                        <td>{{ paciente.hospital_origen|default:"-" }}</td>
                        <td>{{ paciente.numero_ingresos }}</td>
                        <td>{{ paciente.fecha_ingreso|date:"d/m/Y H:i" }}</td>
                        <td>
                            <button onclick="confirmarAlta('{{ paciente.id }}')">Dar de alta</button>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="12">No hay pacientes registrados</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <br><br>
    <a href="{% url 'jefa:agregar_pacientes' %}">Agregar Paciente</a>
    <br><br>
    <a href="{% url 'jefa:menu_jefa' %}">Volver al Menú</a>
</body>
</html>